<!DOCTYPE html>
<html lang="PT-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEPD</title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="lib/jquery-3.3.1.min.js"></script>
    <script src="lib/scripts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx-style/0.8.16/xlsx-style.min.js"></script>
    <link rel="icon" href="imagens/SEPD.png" type="image/x-icon">
    <style>
        body {
            background-color: #0761AC;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        .container {
            max-width: 100vw;
            padding: 0 2vw;
        }

        .barraSuperior {
            height: 10%;
            display: flex;
            align-items: center;
            margin-top: 3%;
        }

        .uespiLogo {
            max-width: 100%;
        }

        .uespiTexto {
            font-size: 3.5vw;
            font-weight: 800;
            color: #DAE908;
            margin: 0;
            text-align: center;
            flex-grow: 1;
        }

        .row {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1%;
        }

        .senhaAtual {
            background-color: #0761AC;
            color: #FFFFFF;
            padding: 2% 0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .senhaGuicheContainer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
        }

        .senhaAtualTexto, .guicheTexto {
            font-size: 5vw;
            font-weight: 600;
            color: #FFFFFF;
            margin: 0;
        }

        #senhaAtualNumero {
            font-size: 8vw;
            font-weight: 600;
            color: #DAE908;
            margin-left: 1vw;
        }

        #guicheNumero {
            font-size: 8vw;
            font-weight: 700;
            color: #DAE908;
        }

        .ultimaSenha {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #ultimaSenhaTexto {
            font-size: 4vw;
            color: #DAE908;
            margin-bottom: 0%;
        }

        #senhaDescricao {
            font-size: 5vw;
            color: #ffff;
            margin-top: 0%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #ultimaSenhaNumero {
            font-size: 7vw;
            color: #DAE908;
            margin-top: 0%;
        }

        .contagemAtendimentos {
            margin-top: 5%;
            font-size: 4vw;
            color: #ffffff;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container page">
        <div class="row barraSuperior">
            <div class="col-xs-2">
                <img src="imagens/SEPD.png" class="uespiLogo">
            </div>
            <div class="col-xs-10">
                <span class="uespiTexto">CONTROLE DE SENHA CAD-BRB - GAMA</span>
            </div>
        </div>
        <div class="row senhaAtual">
            <div class="senhaGuicheContainer">
                <div>
                    <div class="guicheTexto">GUICHÊ</div>
                    <span id="guicheNumero">0</span>
                </div>
                <div>
                    <div class="senhaAtualTexto">SENHA</div>
                    <span id="senhaAtualNumero">0000</span>
                </div>
            </div>
        </div>
        <div class="row ultimaSenha">
            <span id="ultimaSenhaTexto">ÚLTIMA SENHA CHAMADA</span><br>
            <div id="senhaDescricao">
                Senha:    
                <span id="ultimaSenhaNumero">0000</span>
            </div>
        </div>
        <div class="row contagemAtendimentos">
            <span id="contagemAtendimentosTexto">Atendimentos Hoje: 0</span>
        </div>
    </div>
    <audio id="audioChamada" src="audio/chamada.wav"></audio>

    <script>
        // Inicializar valores
        let senhaAtual = 0;
        let ultimaSenha = 0;
        let contagemAtendimentos = 0;
        let registrosAtendimentos = [];

        // Mapear senhas para guichês
        const guiches = {
            1: "01",
            2: "02",
            3: "03",
            4: "04",
            5: "05",
            6: "06"
        };

        // Mapear status dos guichês (ocupado ou liberado)
        let guichesStatus = {
            1: "liberado",
            2: "liberado",
            3: "liberado",
            4: "liberado",
            5: "liberado",
            6: "liberado"
        };

        // Função para formatar a data e hora
        function formatarDataHora(dataHora) {
            return {
                data: dataHora.toLocaleDateString('pt-BR'),
                hora: dataHora.toLocaleTimeString('pt-BR')
            };
        }

        // Função para atualizar o display da senha, guichê e contagem
        function atualizarDisplay(prefixo = "") {
            document.getElementById('senhaAtualNumero').textContent = prefixo + senhaAtual.toString().padStart(4, '0');
            document.getElementById('ultimaSenhaNumero').textContent = prefixo + ultimaSenha.toString().padStart(4, '0');
            document.getElementById('contagemAtendimentosTexto').textContent = "Atendimentos Hoje: " + contagemAtendimentos;
        }

        // Função para incrementar a senha e direcionar ao guichê apropriado
        function incrementarSenha(prefixo) {
            ultimaSenha = senhaAtual;
            senhaAtual++;
            contagemAtendimentos++;

            let guicheAtual = prompt("Digite o número do guichê (1-6) para a próxima senha:");

            if (guiches[guicheAtual]) {
                guichesStatus[guicheAtual] = "ocupado";
                document.getElementById('guicheNumero').textContent = guiches[guicheAtual];
                
                // Capturar data e hora do atendimento
                let dataHoraAtual = new Date();
                let dataHoraFormatada = formatarDataHora(dataHoraAtual);
                let registro = {
                    Data: dataHoraFormatada.data,
                    Hora: dataHoraFormatada.hora,
                    Senha: prefixo + senhaAtual.toString().padStart(4, '0'),
                    Guiche: guiches[guicheAtual]
                };
                registrosAtendimentos.push(registro);
                
                atualizarDisplay(prefixo);
                document.getElementById('audioChamada').play();
            } else {
                alert("Guichê inválido.");
                senhaAtual--;
                contagemAtendimentos--;
            }
        }

        // Função para resetar senhas e contagem de atendimentos
        function resetarSenhas() {
            senhaAtual = 0;
            ultimaSenha = 0;
            atualizarDisplay();
        }

        // Função para resetar guichê
        function resetarGuiche() {
            for (let guiche in guichesStatus) {
                guichesStatus[guiche] = "liberado";
            }
            document.getElementById('guicheNumero').textContent = "0";
            atualizarDisplay();
        }

        // Função para resetar senhas e guichê
        function resetarSenhasEGuiche() {
            resetarSenhas();
            resetarGuiche();
        }

        // Função para exportar os dados para Excel
        function exportarParaExcel() {
            const estiloCabecalho = {
                font: { bold: true, caps: true },
                fill: { fgColor: { rgb: "FFFF00" } },
                alignment: { horizontal: "center" }
            };

            const estiloResumo = {
                font: { bold: true },
                alignment: { horizontal: "center" }
            };

            let wsAtendimentos = XLSX.utils.json_to_sheet(registrosAtendimentos);
            let wsAtendimentosRange = XLSX.utils.decode_range(wsAtendimentos['!ref']);
            
            for (let col = wsAtendimentosRange.s.c; col <= wsAtendimentosRange.e.c; col++) {
                const cellAddress = { c: col, r: wsAtendimentosRange.s.r };
                const cellRef = XLSX.utils.encode_cell(cellAddress);
                if (wsAtendimentos[cellRef]) {
                    wsAtendimentos[cellRef].s = estiloCabecalho;
                }
            }

            let wsResumo = XLSX.utils.aoa_to_sheet([
                ["Total de Atendimentos", contagemAtendimentos],
                ["Total de Senhas Geradas", senhaAtual]
            ]);

            const cellAddresses = [
                { c: 0, r: 0 },
                { c: 1, r: 0 },
                { c: 0, r: 1 },
                { c: 1, r: 1 }
            ];

            cellAddresses.forEach(({ c, r }) => {
                const cellAddress = { c, r };
                const cellRef = XLSX.utils.encode_cell(cellAddress);
                if (wsResumo[cellRef]) {
                    wsResumo[cellRef].s = estiloResumo;
                }
            });

            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, wsAtendimentos, "Atendimentos");
            XLSX.utils.book_append_sheet(wb, wsResumo, "Resumo");

            let nomeArquivo = `atendimentos_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, nomeArquivo);
        }

        // Adicionar evento para as teclas de atalho
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowRight') {
                incrementarSenha('CAD');
            } else if (event.key === 'ArrowUp') {
                incrementarSenha('BRB');
            } else if (event.key === 'r') {
                resetarSenhas();
                resetarGuiche();
            } else if (event.key === 's') {
                exportarParaExcel();
            }
        });
    </script>
</body>
</html>
